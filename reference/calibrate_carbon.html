<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="description" content="
This function drives a workflow that reads in NEON carbon isotope data
of atmospheric CO2, calibrates it to the VPDB scale, and (optionally)
writes the calibrated data to a new HDF5 file. Two different approaches
are possible: a) a calibration on 12CO2 and 13CO2 isotopologues
independently, after Bowling et al. 2003 (Agr. For. Met.), or b) a direct
calibration of d13C and CO2 values using linear regression. Most of the time
the results generated are extremely similar to each other.
Wen et al. 2013 compared several different carbon
isotope calibration techniques and found this to be the superior method
under most circumstances. We also found this to be the case for NEON data
(Fiorella et al. 2021; JGR-Biogeosciences)."><title>calibrate_carbon — calibrate_carbon • NEONiso</title><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous"><!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="calibrate_carbon — calibrate_carbon"><meta property="og:description" content="
This function drives a workflow that reads in NEON carbon isotope data
of atmospheric CO2, calibrates it to the VPDB scale, and (optionally)
writes the calibrated data to a new HDF5 file. Two different approaches
are possible: a) a calibration on 12CO2 and 13CO2 isotopologues
independently, after Bowling et al. 2003 (Agr. For. Met.), or b) a direct
calibration of d13C and CO2 values using linear regression. Most of the time
the results generated are extremely similar to each other.
Wen et al. 2013 compared several different carbon
isotope calibration techniques and found this to be the superior method
under most circumstances. We also found this to be the case for NEON data
(Fiorella et al. 2021; JGR-Biogeosciences)."><!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">NEONiso</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.6.2</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="active nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/example_workflow.html">Getting Started with NEONiso</a>
    <a class="dropdown-item" href="../articles/reference_corrections.html">Reference Corrections</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul><form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off"></form>

      <ul class="navbar-nav"><li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/lanl/NEONiso/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul></div>

    
  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>calibrate_carbon</h1>
      <small class="dont-index">Source: <a href="https://github.com/lanl/NEONiso/blob/HEAD/R/calibrate_carbon.R" class="external-link"><code>R/calibrate_carbon.R</code></a></small>
      <div class="d-none name"><code>calibrate_carbon.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p><a href="https://lifecycle.r-lib.org/articles/stages.html#experimental" class="external-link"><img src="figures/lifecycle-experimental.svg" alt="[Experimental]"></a>
This function drives a workflow that reads in NEON carbon isotope data
of atmospheric CO2, calibrates it to the VPDB scale, and (optionally)
writes the calibrated data to a new HDF5 file. Two different approaches
are possible: a) a calibration on 12CO2 and 13CO2 isotopologues
independently, after Bowling et al. 2003 (Agr. For. Met.), or b) a direct
calibration of d13C and CO2 values using linear regression. Most of the time
the results generated are extremely similar to each other.
Wen et al. 2013 compared several different carbon
isotope calibration techniques and found this to be the superior method
under most circumstances. We also found this to be the case for NEON data
(Fiorella et al. 2021; JGR-Biogeosciences).</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">calibrate_carbon</span><span class="op">(</span></span>
<span>  <span class="va">inname</span>,</span>
<span>  <span class="va">outname</span>,</span>
<span>  <span class="va">site</span>,</span>
<span>  method <span class="op">=</span> <span class="st">"Bowling_2003"</span>,</span>
<span>  calibration_half_width <span class="op">=</span> <span class="fl">0.5</span>,</span>
<span>  force_cal_to_beginning <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  force_cal_to_end <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  gap_fill_parameters <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  filter_ambient <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  r2_thres <span class="op">=</span> <span class="fl">0.95</span>,</span>
<span>  correct_refData <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  write_to_file <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  remove_known_bad_months <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  plot_regression_data <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  plot_directory <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  avg <span class="op">=</span> <span class="fl">9</span></span>
<span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>
    <dl><dt>inname</dt>
<dd><p>Input file(s) that are to be calibrated. If a single file is
given, output will be a single file per site per month. If a
list of files corresponding to a timeseries at a given site
is provided, will calibrate the whole time series.</p></dd>


<dt>outname</dt>
<dd><p>Name of the output file. (character)</p></dd>


<dt>site</dt>
<dd><p>Four letter NEON site code for site being processed. (character)</p></dd>


<dt>method</dt>
<dd><p>Are we using the Bowling et al. 2003 method
("Bowling_2003") or direct linear regression of
d13C and CO2 mole fractions ("linreg")?</p></dd>


<dt>calibration_half_width</dt>
<dd><p>Determines the period (in days)
from which reference data are selected (period
is 2*calibration_half_width).</p></dd>


<dt>force_cal_to_beginning</dt>
<dd><p>Extend first calibration to the beginning
of the file? (default true)</p></dd>


<dt>force_cal_to_end</dt>
<dd><p>Extend last calibration to the end of the file?
(default true)</p></dd>


<dt>gap_fill_parameters</dt>
<dd><p>Should function attempt to 'gap-fill' across a
bad calibration by carrying the last good calibration forward?
Implementation is fairly primitive currently, as it only carries
the last known good calibration that's available forward rather
than interpolating, etc. Default FALSE.</p></dd>


<dt>filter_ambient</dt>
<dd><p>Apply the median absolute deviation filter (Brock 86)
to remove impulse spikes in output ambient data?
(logical; default true)</p></dd>


<dt>r2_thres</dt>
<dd><p>Minimum r2 threshold of an "acceptable" calibration. Acts to
remove calibration periods where a measurement error makes
relationship nonlinear. Default = 0.95</p></dd>


<dt>correct_refData</dt>
<dd><p>NEON has indicated there are a few instances where
reported d13C or CO2 reference values are wrong. If set to true,
correct known incorrect values. This argument will (hopefully,
eventually) go away after NEON has fixed the reference database.
Users will be warned prior to removal of this argument.</p></dd>


<dt>write_to_file</dt>
<dd><p>Write calibrated ambient data to file?
(Mostly used for testing)</p></dd>


<dt>remove_known_bad_months</dt>
<dd><p>There are a few site months with known
spectral issues where the isotope ratios are likely unrecoverable.
This parameter allows removal of these files, but allows them to
remain in archive.</p></dd>


<dt>plot_regression_data</dt>
<dd><p>Default false; this is useful for diagnostics.</p></dd>


<dt>plot_directory</dt>
<dd><p>Only used if plot_regression_data is TRUE, but specify
where to write out diagnostic plot of regression data.</p></dd>


<dt>avg</dt>
<dd><p>The averaging interval to extract, in minutes. Default 9, but will
change to 6 eventually.</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a></h2>
    

<p>Returns nothing to the environment, but creates a new output HDF5
file containing calibrated carbon isotope values.</p>
    </div>
    <div class="section level2">
    <h2 id="details">Details<a class="anchor" aria-label="anchor" href="#details"></a></h2>
    <p>The 'linreg' method simply takes measured and reference d13C and CO2 values
and generates a transfer function between them using <code><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm()</a></code>. For the
gain-and-offset method, d13C and CO2 values are converted to 12CO2 and 13CO2
mole fractions. Gain and offset parameters are calculated for each
isotopologue independently, and are analogous to regression slope and
intercepts, but jointly correct for CO2 concentration dependence
and place d13C values on the VPDB scale.
The gain and offset parameters are defined by:</p>
<p>$$G = (X_{2,ref}-X_{1,ref})/(X_{2,meas}-X_{1,meas})$$
$$O = X_{2,ref}- G X_{2,meas}$$
Calibrated ambient isotopologues are then given as:
$$X_{cal} = X_{meas} G + O$$</p>
<p>Measurements of reference materials were considered "good" if the following
conditions were met:</p><ul><li><p>Measured CO2 concentrations were within 10 ppm
of known "reference" concentrations.</p></li>
<li><p>Variance of the CO2 concentration in standard peak was &lt; 5 ppm.</p></li>
<li><p>Measured d13C value must be within 5 per mil
of known "reference" d13C value.</p></li>
</ul><p>The first two criteria are intended to filter out periods where there is
a clear issue with the gas delivery system (i.e., nearly empty gas tank,
problem with a valve in the manifold, etc.); the third criterion was adopted
after visual inspection of data timeseries revealed that often the first
standard measurement following an instrument issue had higher-than-expected
error. This criterion clips clearly poor values. Selection of these criteria
will become a function argument, and therefore customizable,
in a future release.</p>
<p>The behavior of this function will be a bit different depending on what
is supplied as <code>inname</code>. If a single file is provided, the output will be
monthly. However, a list of files corresponding to a site can also be
provided, and then a single output file per site will be generated.</p>
    </div>
    <div class="section level2">
    <h2 id="author">Author<a class="anchor" aria-label="anchor" href="#author"></a></h2>
    <p>Rich Fiorella <a href="mailto:rfiorella@lanl.gov">rfiorella@lanl.gov</a></p>
    </div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span><span class="kw">if</span> <span class="op">(</span><span class="cn">FALSE</span><span class="op">)</span> <span class="va">fin</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">'extdata'</span>,</span></span>
<span class="r-in"><span><span class="st">'NEON.D15.ONAQ.DP4.00200.001.nsae.2019-05.basic.20201020T211037Z.packed.h5'</span>,</span></span>
<span class="r-in"><span>         package <span class="op">=</span> <span class="st">'NEONiso'</span>, mustWork <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="calibrate_carbon_bymonth.html">calibrate_carbon_bymonth</a></span><span class="op">(</span>inname <span class="op">=</span> <span class="va">fin</span>, outname <span class="op">=</span> <span class="st">'out.h5'</span>,</span></span>
<span class="r-in"><span>         site <span class="op">=</span> <span class="st">'ONAQ'</span>, write_to_file <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> <span class="warning">Warning: </span>`calibrate_carbon_bymonth()` was deprecated in NEONiso 0.6.0.</span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> <span style="color: #00BBBB;">ℹ</span> Please use `calibrate_carbon()` instead.</span>
<span class="r-err co"><span class="r-pr">#&gt;</span> <span class="error">Error in eval(expr, envir, enclos):</span> object 'fin' not found</span>
<span class="r-in"><span><span class="fu"><a href="calibrate_carbon_bymonth.html">calibrate_carbon_bymonth</a></span><span class="op">(</span>inname <span class="op">=</span> <span class="va">fin</span>, outname <span class="op">=</span> <span class="st">'out.h5'</span>,</span></span>
<span class="r-in"><span>         site <span class="op">=</span> <span class="st">'ONAQ'</span>, method <span class="op">=</span> <span class="st">'linreg'</span>, write_to_file <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></span>
<span class="r-err co"><span class="r-pr">#&gt;</span> <span class="error">Error in eval(expr, envir, enclos):</span> object 'fin' not found</span>
<span class="r-in"><span></span></span>
</code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p></p><p>Developed by Rich Fiorella.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p><p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer></div>

  

  

  </body></html>

